#!/bin/bash

echo "=== Laravel Malware Cleanup Script ==="
echo "This script will help clean common malware from your Laravel app"
echo ""

# Backup first
echo "[1] Creating backup..."
tar -czf ../backup_before_cleanup_$(date +%Y%m%d_%H%M%S).tar.gz . 2>/dev/null
echo "Backup created"

# Remove suspicious files
echo "[2] Removing suspicious files..."
find . -name "*.php.suspected" -delete
find . -name "*.php~" -delete
find . -name "shell.php" -delete
find . -name "c99.php" -delete
find . -name "r57.php" -delete
find . -name "*.php.bak" -delete

# Clean common malware patterns from PHP files
echo "[3] Cleaning PHP files..."
find . -name "*.php" -type f -exec sed -i 's/eval(base64_decode[^;]*;//g' {} \;
find . -name "*.php" -type f -exec sed -i 's/eval(gzinflate[^;]*;//g' {} \;
find . -name "*.php" -type f -exec sed -i 's/eval(str_rot13[^;]*;//g' {} \;

# Fix permissions
echo "[4] Fixing file permissions..."
find . -type d -exec chmod 755 {} \;
find . -type f -exec chmod 644 {} \;
chmod -R 775 storage
chmod -R 775 bootstrap/cache

# Clear Laravel caches
echo "[5] Clearing Laravel caches..."
php artisan cache:clear
php artisan config:clear
php artisan route:clear
php artisan view:clear

# Regenerate autoload files
echo "[6] Regenerating autoload files..."
composer dump-autoload

echo ""
echo "=== Cleanup Complete ==="
echo "Next steps:"
echo "1. Run: php security_check.php"
echo "2. Check your site functionality"
echo "3. Request Google review"
